#!/usr/bin/env bash
# TACO v3 - Pure Bash Implementation
# Identical functionality to Python v3 but with zero dependencies

set -euo pipefail

VERSION="3.0.0"
SESSION_NAME="taco"
CLAUDE_MODEL="sonnet"
PROJECT_PROMPT=""
PROJECT_DIR=""
DEBUG=false
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATES_DIR="$SCRIPT_DIR/taco/templates"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Agents array
declare -a AGENTS
declare -a AGENT_NAMES
declare -a AGENT_WINDOWS
declare -a AGENT_ROLES

# Check dependencies
check_dependencies() {
    local missing=()
    command -v tmux >/dev/null 2>&1 || missing+=("tmux")
    command -v claude >/dev/null 2>&1 || missing+=("claude")
    command -v jq >/dev/null 2>&1 || missing+=("jq")
    
    if [ ${#missing[@]} -gt 0 ]; then
        echo -e "${RED}Error: Missing dependencies: ${missing[*]}${NC}" >&2
        echo "Install with: brew install ${missing[*]}" >&2
        exit 1
    fi
}

# Logger
log() {
    local level="$1"
    shift
    local msg="$*"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    case "$level" in
        INFO) echo -e "${timestamp} [${GREEN}INFO${NC}] $msg" >&2 ;;
        WARN) echo -e "${timestamp} [${YELLOW}WARN${NC}] $msg" >&2 ;;
        ERROR) echo -e "${timestamp} [${RED}ERROR${NC}] $msg" >&2 ;;
    esac
}

# Show logo
show_logo() {
    cat <<'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë      TACO v3.0 - Pure Bash Edition             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
}

# Get interactive prompt
get_interactive_prompt() {
    show_logo
    echo
    echo -e "${YELLOW}üí¨ What would you like to build?${NC}"
    echo -e "${CYAN}   (Describe your project, then press Enter twice)${NC}"
    echo
    
    local lines=()
    local empty_count=0
    
    while true; do
        read -r -p "‚îÇ  " line || break
        
        if [ -z "$line" ]; then
            empty_count=$((empty_count + 1))
            [ $empty_count -ge 2 ] && break
            [ $empty_count -ge 1 ] && [ ${#lines[@]} -gt 0 ] && break
        else
            empty_count=0
            lines+=("$line")
        fi
    done
    
    echo
    printf '%s\n' "${lines[@]}"
}

# Create Mother prompt from template
create_mother_prompt() {
    local user_request="$1"
    USER_REQUEST="$user_request" envsubst < "$TEMPLATES_DIR/mother-prompt.txt"
}

# Create agent prompt from template
create_agent_prompt() {
    local name="$1"
    local window="$2"
    local role="$3"
    local depends="$4"
    local notifies="$5"
    
    AGENT_NAME="$name" \
    AGENT_WINDOW="$window" \
    AGENT_ROLE="$role" \
    DEPENDS_ON="$depends" \
    NOTIFIES="$notifies" \
    envsubst < "$TEMPLATES_DIR/agent-prompt.txt"
}

# Wait for specification with timeout
wait_for_specification() {
    local target="${SESSION_NAME}:0.0"
    local spec_file="$PROJECT_DIR/.orchestrator/agent_spec.txt"
    local timeout=180
    local elapsed=0
    local wait_time=2
    
    log INFO "üìã Waiting for Mother to generate specification..."
    
    while [ $elapsed -lt $timeout ]; do
        # Capture pane content
        tmux capture-pane -t "$target" -p -S -3000 > "$spec_file" 2>/dev/null || true
        
        # Check for completion markers
        if grep -q "<<<DONE>>>" "$spec_file" && \
           grep -q "AGENT_SPEC_JSON_START" "$spec_file" && \
           grep -q "Begin your analysis and design now" "$spec_file"; then
            log INFO "‚úÖ Specification received!"
            return 0
        fi
        
        echo -ne "\r${CYAN}Waiting... ${elapsed}s${NC}" >&2
        sleep $wait_time
        elapsed=$((elapsed + wait_time))
    done
    
    log ERROR "Timeout waiting for specification"
    return 1
}

# Parse JSON specification using jq
parse_json_spec() {
    local spec_file="$1"
    
    # Extract JSON block
    local json_block=$(sed -n '/AGENT_SPEC_JSON_START/,/AGENT_SPEC_JSON_END/p' "$spec_file" | \
                      grep -v "AGENT_SPEC_JSON" | \
                      sed 's/^[[:space:]]*//' | \
                      grep -v '^```' | \
                      grep -v '^>' | \
                      tr -d '\r')
    
    # Parse with jq
    local agents_json=$(echo "$json_block" | jq -r '.agents' 2>/dev/null)
    
    if [ -z "$agents_json" ] || [ "$agents_json" = "null" ]; then
        return 1
    fi
    
    # Parse each agent
    local count=$(echo "$agents_json" | jq 'length')
    
    for ((i=0; i<count; i++)); do
        local agent=$(echo "$agents_json" | jq ".[$i]")
        local window=$(echo "$agent" | jq -r '.window')
        local name=$(echo "$agent" | jq -r '.name')
        local role=$(echo "$agent" | jq -r '.role')
        
        AGENT_WINDOWS+=("$window")
        AGENT_NAMES+=("$name")
        AGENT_ROLES+=("$role")
    done
    
    log INFO "Parsed ${#AGENT_NAMES[@]} agents"
    return 0
}

# Create agent windows
create_agent_windows() {
    local model_flag=""
    [ -n "$CLAUDE_MODEL" ] && model_flag="--model $CLAUDE_MODEL"
    
    for ((i=0; i<${#AGENT_NAMES[@]}; i++)); do
        local window="${AGENT_WINDOWS[$i]}"
        local name="${AGENT_NAMES[$i]}"
        local role="${AGENT_ROLES[$i]}"
        
        log INFO "Creating agent: $name (window $window)"
        
        # Create window
        tmux new-window -t "${SESSION_NAME}:${window}" -n "$name" -c "$PROJECT_DIR"
        
        # Start Claude
        tmux send-keys -t "${SESSION_NAME}:${window}.0" "claude --dangerously-skip-permissions $model_flag" Enter
        sleep 5
        
        # Accept trust
        tmux send-keys -t "${SESSION_NAME}:${window}.0" "1" Enter
        sleep 2
        
        # Send agent prompt
        local prompt=$(create_agent_prompt "$name" "$window" "$role" "none" "none")
        printf '%s' "$prompt" | tmux load-buffer -
        tmux paste-buffer -t "${SESSION_NAME}:${window}.0"
        sleep 0.5
        tmux send-keys -t "${SESSION_NAME}:${window}.0" Enter
    done
    
    log INFO "All agents created"
}

# Send coordination prompt
send_coordination_prompt() {
    local target="${SESSION_NAME}:0.0"
    
    # Build agents info
    local agents_info=""
    for ((i=0; i<${#AGENT_NAMES[@]}; i++)); do
        agents_info+="  Window ${AGENT_WINDOWS[$i]}: ${AGENT_NAMES[$i]}\n"
        agents_info+="    Role: ${AGENT_ROLES[$i]}\n\n"
    done
    
    # Load and substitute template
    AGENTS_INFO="$agents_info" \
    PROJECT_DIR="$PROJECT_DIR" \
    envsubst < "$TEMPLATES_DIR/coordination-prompt.txt" > /tmp/coord_prompt.txt
    
    # Send to Mother
    log INFO "üéØ Sending coordination prompt to Mother..."
    tmux send-keys -t "$target" C-u
    sleep 0.5
    
    cat /tmp/coord_prompt.txt | tmux load-buffer -
    tmux paste-buffer -t "$target"
    sleep 0.5
    tmux send-keys -t "$target" Enter
    
    rm -f /tmp/coord_prompt.txt
}

# Main orchestration flow
main() {
    # Check deps
    check_dependencies
    
    # Parse args
    while [[ $# -gt 0 ]]; do
        case $1 in
            -f|--file)
                [ ! -f "$2" ] && { log ERROR "File not found: $2"; exit 1; }
                PROJECT_PROMPT=$(cat "$2")
                shift 2
                ;;
            -p|--prompt)
                PROJECT_PROMPT="$2"
                shift 2
                ;;
            -m|--model)
                CLAUDE_MODEL="$2"
                shift 2
                ;;
            --session-name)
                SESSION_NAME="$2"
                shift 2
                ;;
            -v|--version)
                echo "TACO v$VERSION (Bash Edition)"
                exit 0
                ;;
            -h|--help)
                echo "Usage: $0 [-f FILE] [-p PROMPT] [-m MODEL] [--session-name NAME]"
                exit 0
                ;;
            *)
                log ERROR "Unknown option: $1"
                exit 1
                ;;
        esac
    done
    
    # Get prompt if not provided
    [ -z "$PROJECT_PROMPT" ] && PROJECT_PROMPT=$(get_interactive_prompt)
    [ -z "$PROJECT_PROMPT" ] && { log ERROR "No project description"; exit 1; }
    
    # Setup
    log INFO "‚ö° TACO Bash v3 initialized"
    
    # Create project dir
    PROJECT_DIR="$(pwd)/taco-project-$(date +%Y%m%d-%H%M%S)"
    mkdir -p "$PROJECT_DIR/.orchestrator"
    log INFO "üìÅ Project: $PROJECT_DIR"
    
    # Start tmux
    tmux has-session -t "$SESSION_NAME" 2>/dev/null && tmux kill-session -t "$SESSION_NAME"
    tmux new-session -d -s "$SESSION_NAME" -n "mother" -c "$PROJECT_DIR"
    log INFO "üñ•Ô∏è  Session: $SESSION_NAME"
    
    # Start Mother
    log INFO "ü§ñ Starting Mother agent..."
    local target="${SESSION_NAME}:0.0"
    local model_flag=""
    [ -n "$CLAUDE_MODEL" ] && model_flag="--model $CLAUDE_MODEL"
    
    tmux send-keys -t "$target" "claude --dangerously-skip-permissions $model_flag" Enter
    sleep 5
    tmux send-keys -t "$target" "1" Enter
    sleep 2
    
    # Send Mother prompt
    local mother_prompt=$(create_mother_prompt "$PROJECT_PROMPT")
    printf '%s' "$mother_prompt" | tmux load-buffer -
    tmux paste-buffer -t "$target"
    sleep 0.5
    tmux send-keys -t "$target" Enter
    
    # Wait for spec
    wait_for_specification || exit 1
    
    # Parse spec
    parse_json_spec "$PROJECT_DIR/.orchestrator/agent_spec.txt" || {
        log ERROR "Failed to parse specification"
        exit 1
    }
    
    # Create agents
    create_agent_windows
    
    # Send coordination
    sleep 10
    send_coordination_prompt
    
    # Done
    log INFO "üéâ Orchestration complete!"
    echo
    echo -e "${GREEN}Attaching to session in 3 seconds...${NC}"
    sleep 3
    
    tmux attach -t "${SESSION_NAME}:0"
}

main "$@"
