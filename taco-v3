#!/usr/bin/env bash
# TACO v3 - Pure Bash Implementation
# Identical functionality to Python v3 but with zero dependencies

set -euo pipefail

VERSION="3.0.0"
SESSION_NAME="taco"
CLAUDE_MODEL="sonnet"  # Always use sonnet
PROJECT_PROMPT=""
PROJECT_DIR=""
PROJECT_NAME=""
USE_NEW_DIR=true
DEBUG=false
QUICK_MODE=false
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATES_DIR="$SCRIPT_DIR/taco/templates"

# Questionnaire answers
PROJECT_TYPE=""
PROJECT_COMPLEXITY=""
AGENT_COUNT="auto"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
GRAY='\033[0;90m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Agents array
declare -a AGENTS
declare -a AGENT_NAMES
declare -a AGENT_WINDOWS
declare -a AGENT_ROLES

# Questionnaire answers
PROJECT_TYPE=""
PROJECT_COMPLEXITY=""
AGENT_COUNT="auto"

# Beautiful ASCII TACO logo with burgundy gradient
show_taco_logo() {
    clear
    echo
    echo
    # Burgundy gradient colors
    local BURG1='\033[38;5;88m'   # Dark burgundy
    local BURG2='\033[38;5;124m'  # Medium burgundy
    local BURG3='\033[38;5;160m'  # Lighter burgundy
    local BURG4='\033[38;5;196m'  # Light red-burgundy

    echo -e "${BOLD}${BURG1}"
    echo -e "    ████████╗  █████╗   ██████╗  ██████╗ "
    echo -e "${BURG2}    ╚══██╔══╝ ██╔══██╗ ██╔════╝ ██╔═══██╗"
    echo -e "${BURG2}       ██║    ███████║ ██║      ██║   ██║"
    echo -e "${BURG3}       ██║    ██╔══██║ ██║      ██║   ██║"
    echo -e "${BURG3}       ██║    ██║  ██║ ╚██████╗ ╚██████╔╝"
    echo -e "${BURG4}       ╚═╝    ╚═╝  ╚═╝  ╚═════╝  ╚═════╝ ${NC}"
    echo
    echo -e "${BURG2}           Tmux Agent Command Orchestrator${NC}"
    echo -e "${DIM}                Made by Daedastream LLC${NC}"
    echo
    echo
}

# Progress spinner
spinner() {
    local pid=$1
    local message=$2
    local spinstr='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'

    while kill -0 $pid 2>/dev/null; do
        local temp=${spinstr#?}
        printf " ${CYAN}%c${NC}  %s" "$spinstr" "$message"
        local spinstr=$temp${spinstr%"$temp"}
        sleep 0.1
        printf "\r"
    done
    printf "    \r"
}

# Beautiful section header
section_header() {
    local title="$1"
    echo
    echo -e "${BOLD}${WHITE}╔════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BOLD}${WHITE}║${NC}  ${BOLD}${CYAN}$title${NC}"
    echo -e "${BOLD}${WHITE}╚════════════════════════════════════════════════════════════════════╝${NC}"
    echo
}

# Step indicator
show_step() {
    local current=$1
    local total=$2
    local title="$3"

    echo
    echo -e "${BOLD}${MAGENTA}▶${NC} ${BOLD}Step $current/$total:${NC} ${WHITE}$title${NC}"
    echo -e "${DIM}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

# Success message
show_success() {
    echo -e "${GREEN}✓${NC} $*"
}

# Info message
show_info() {
    echo -e "${CYAN}ℹ${NC} $*"
}

# Warning message
show_warn() {
    echo -e "${YELLOW}⚠${NC} $*"
}

# Progress bar
progress_bar() {
    local current=$1
    local total=$2
    local width=50
    local percentage=$((current * 100 / total))
    local filled=$((width * current / total))
    local empty=$((width - filled))

    printf "\r${CYAN}["
    printf "%${filled}s" | tr ' ' '█'
    printf "%${empty}s" | tr ' ' '░'
    printf "]${NC} ${BOLD}%3d%%${NC}" $percentage
}

# Check dependencies
check_dependencies() {
    section_header "SYSTEM CHECK"

    local missing=()
    local deps=("tmux" "claude" "jq" "envsubst")
    local total=${#deps[@]}
    local current=0

    for dep in "${deps[@]}"; do
        current=$((current + 1))
        if command -v "$dep" >/dev/null 2>&1; then
            show_success "${BOLD}$dep${NC} is installed $(command -v $dep)"
        else
            show_warn "${BOLD}$dep${NC} is ${RED}missing${NC}"
            missing+=("$dep")
        fi
    done

    if [ ${#missing[@]} -gt 0 ]; then
        echo
        echo -e "${RED}${BOLD}✗ Missing dependencies:${NC} ${missing[*]}"
        echo -e "${YELLOW}Install with:${NC} ${BOLD}brew install ${missing[*]}${NC}"
        exit 1
    fi

    echo
    show_success "${BOLD}All dependencies satisfied!${NC}"
    sleep 1
}

# Interactive questionnaire
run_questionnaire() {
    section_header "PROJECT QUESTIONNAIRE"

    echo -e "${WHITE}Let's gather some details about your project...${NC}"
    echo

    # Question 0: Auto or Manual
    show_step 1 1 "Configuration mode"
    echo
    echo -e "  ${BOLD}1)${NC} ${GREEN}Auto${NC} ${DIM}(Let Mother analyze and decide everything)${NC}"
    echo -e "  ${BOLD}2)${NC} ${CYAN}Manual${NC} ${DIM}(Choose project type and complexity)${NC}"
    echo
    read -r -p "$(echo -e ${YELLOW}❯${NC} Choose [1-2, default 1]): " mode_choice

    if [[ "$mode_choice" == "2" ]]; then
        # Manual mode - ask all questions
        run_manual_configuration
    else
        # Auto mode - just get description
        show_success "Mode: ${BOLD}Auto${NC} ${DIM}(Mother will analyze your project)${NC}"
        run_auto_configuration
    fi
}

# Manual configuration with all questions
run_manual_configuration() {
    # Question 1: Project Type
    show_step 2 4 "What type of project are you building?"
    echo
    echo -e "  ${BOLD}1)${NC} ${CYAN}Web Application${NC} ${DIM}(Frontend + Backend)${NC}"
    echo -e "  ${BOLD}2)${NC} ${CYAN}Mobile App${NC} ${DIM}(iOS, Android, or React Native)${NC}"
    echo -e "  ${BOLD}3)${NC} ${CYAN}API/Backend Service${NC} ${DIM}(REST, GraphQL, Microservices)${NC}"
    echo -e "  ${BOLD}4)${NC} ${CYAN}CLI Tool${NC} ${DIM}(Command-line utility)${NC}"
    echo -e "  ${BOLD}5)${NC} ${CYAN}Data/ML Pipeline${NC} ${DIM}(ETL, Machine Learning)${NC}"
    echo -e "  ${BOLD}6)${NC} ${CYAN}Other${NC} ${DIM}(I'll describe it)${NC}"
    echo
    read -r -p "$(echo -e ${YELLOW}❯${NC} Choose [1-6]): " project_type_choice

    case $project_type_choice in
        1) PROJECT_TYPE="Web Application" ;;
        2) PROJECT_TYPE="Mobile App" ;;
        3) PROJECT_TYPE="API/Backend Service" ;;
        4) PROJECT_TYPE="CLI Tool" ;;
        5) PROJECT_TYPE="Data/ML Pipeline" ;;
        *) PROJECT_TYPE="Other" ;;
    esac

    show_success "Project type: ${BOLD}$PROJECT_TYPE${NC}"

    # Question 2: Complexity
    show_step 3 4 "What's the complexity level?"
    echo
    echo -e "  ${BOLD}1)${NC} ${GREEN}Simple${NC} ${DIM}(Single file, basic functionality)${NC}"
    echo -e "  ${BOLD}2)${NC} ${CYAN}Moderate${NC} ${DIM}(Multiple files, some features)${NC}"
    echo -e "  ${BOLD}3)${NC} ${YELLOW}Complex${NC} ${DIM}(Full-stack, many features)${NC}"
    echo -e "  ${BOLD}4)${NC} ${MAGENTA}Enterprise${NC} ${DIM}(Multi-platform, microservices)${NC}"
    echo
    read -r -p "$(echo -e ${YELLOW}❯${NC} Choose [1-4]): " complexity_choice

    case $complexity_choice in
        1) PROJECT_COMPLEXITY="Simple"; AGENT_COUNT=2 ;;
        2) PROJECT_COMPLEXITY="Moderate"; AGENT_COUNT=4 ;;
        3) PROJECT_COMPLEXITY="Complex"; AGENT_COUNT=7 ;;
        4) PROJECT_COMPLEXITY="Enterprise"; AGENT_COUNT=10 ;;
        *) PROJECT_COMPLEXITY="Moderate"; AGENT_COUNT="auto" ;;
    esac

    show_success "Complexity: ${BOLD}$PROJECT_COMPLEXITY${NC} ${DIM}(~$AGENT_COUNT agents)${NC}"

    # Question 3: Description
    show_step 4 4 "Describe your project"
    echo
    echo -e "${DIM}Be as detailed as you want. Press Enter twice when done.${NC}"
    echo

    local lines=()
    local empty_count=0

    while true; do
        if [ ${#lines[@]} -eq 0 ]; then
            read -r -p "$(echo -e ${CYAN}❯${NC} ) " line
        else
            read -r -p "$(echo -e ${DIM}│${NC} ) " line
        fi

        if [ -z "$line" ]; then
            empty_count=$((empty_count + 1))
            [ $empty_count -ge 2 ] && break
            [ $empty_count -ge 1 ] && [ ${#lines[@]} -gt 0 ] && break
        else
            empty_count=0
            lines+=("$line")
        fi
    done

    PROJECT_PROMPT=$(printf '%s\n' "${lines[@]}")
}

# Auto configuration - just get description
run_auto_configuration() {
    show_step 2 2 "Describe your project"
    echo
    echo -e "${DIM}Be as detailed as you want. Press Enter twice when done.${NC}"
    echo

    local lines=()
    local empty_count=0

    while true; do
        if [ ${#lines[@]} -eq 0 ]; then
            read -r -p "$(echo -e ${CYAN}❯${NC} ) " line
        else
            read -r -p "$(echo -e ${DIM}│${NC} ) " line
        fi

        if [ -z "$line" ]; then
            empty_count=$((empty_count + 1))
            [ $empty_count -ge 2 ] && break
            [ $empty_count -ge 1 ] && [ ${#lines[@]} -gt 0 ] && break
        else
            empty_count=0
            lines+=("$line")
        fi
    done

    PROJECT_PROMPT=$(printf '%s\n' "${lines[@]}")

    # Auto-detect settings
    PROJECT_TYPE="Auto-detected by Mother"
    PROJECT_COMPLEXITY="Auto-detected by Mother"
    AGENT_COUNT="auto"

    # Ask about directory
    ask_about_directory
}

# Ask about project directory
ask_about_directory() {
    echo
    echo -e "${WHITE}${BOLD}Project Directory:${NC}"
    echo -e "  ${BOLD}1)${NC} ${GREEN}Create new directory${NC} ${DIM}(Recommended)${NC}"
    echo -e "  ${BOLD}2)${NC} ${CYAN}Use current directory${NC} ${DIM}($(pwd))${NC}"
    echo
    read -r -p "$(echo -e ${YELLOW}❯${NC} Choose [1-2, default 1]): " dir_choice

    if [[ "$dir_choice" == "2" ]]; then
        USE_NEW_DIR=false
        show_success "Using current directory: ${BOLD}$(pwd)${NC}"
    else
        USE_NEW_DIR=true
        echo
        echo -e "${WHITE}What would you like to name your project directory?${NC}"
        echo -e "${DIM}(Leave empty for auto-generated name)${NC}"
        read -r -p "$(echo -e ${CYAN}❯${NC} Project name): " PROJECT_NAME

        if [ -z "$PROJECT_NAME" ]; then
            PROJECT_NAME="taco-project-$(date +%Y%m%d-%H%M%S)"
            show_success "Auto-generated name: ${BOLD}$PROJECT_NAME${NC}"
        else
            # Sanitize project name
            PROJECT_NAME=$(echo "$PROJECT_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//;s/-$//')
            show_success "Project directory: ${BOLD}$PROJECT_NAME${NC}"
        fi
    fi
}

# Quick mode from command line - just get description
get_quick_description() {
    section_header "QUICK START"

    echo -e "${WHITE}Describe your project:${NC}"
    echo -e "${DIM}(Press Enter twice when done)${NC}"
    echo

    local lines=()
    local empty_count=0

    while true; do
        if [ ${#lines[@]} -eq 0 ]; then
            read -r -p "$(echo -e ${CYAN}❯${NC} ) " line
        else
            read -r -p "$(echo -e ${DIM}│${NC} ) " line
        fi

        if [ -z "$line" ]; then
            empty_count=$((empty_count + 1))
            [ $empty_count -ge 2 ] && break
            [ $empty_count -ge 1 ] && [ ${#lines[@]} -gt 0 ] && break
        else
            empty_count=0
            lines+=("$line")
        fi
    done

    PROJECT_PROMPT=$(printf '%s\n' "${lines[@]}")

    # Auto-detect settings (for -q flag)
    PROJECT_TYPE="Auto-detected by Mother"
    PROJECT_COMPLEXITY="Auto-detected by Mother"
    AGENT_COUNT="auto"
    USE_NEW_DIR=true
    PROJECT_NAME="taco-project-$(date +%Y%m%d-%H%M%S)"
}

# Show configuration summary
show_configuration() {
    section_header "CONFIGURATION SUMMARY"

    echo -e "${BOLD}${WHITE}Project Details:${NC}"
    echo -e "  ${CYAN}●${NC} Type:       ${BOLD}$PROJECT_TYPE${NC}"
    echo -e "  ${CYAN}●${NC} Complexity: ${BOLD}$PROJECT_COMPLEXITY${NC}"
    if [ "$AGENT_COUNT" != "auto" ]; then
        echo -e "  ${CYAN}●${NC} Agents:     ${BOLD}~$AGENT_COUNT agents${NC}"
    else
        echo -e "  ${CYAN}●${NC} Agents:     ${BOLD}Auto-determined by Mother${NC}"
    fi
    echo
    echo -e "${BOLD}${WHITE}Description:${NC}"
    echo "$PROJECT_PROMPT" | sed 's/^/  │ /'
    echo

    if [ "$USE_NEW_DIR" = true ]; then
        echo -e "${BOLD}${WHITE}Directory:${NC}"
        echo -e "  ${CYAN}●${NC} New directory: ${BOLD}$(pwd)/$PROJECT_NAME${NC}"
        echo
    else
        echo -e "${BOLD}${WHITE}Directory:${NC}"
        echo -e "  ${CYAN}●${NC} Current directory: ${BOLD}$(pwd)${NC}"
        echo
    fi

    read -r -p "$(echo -e ${YELLOW}Continue? [Y/n]:${NC} )" confirm
    if [[ "$confirm" =~ ^[Nn]$ ]]; then
        echo -e "${RED}Aborted by user${NC}"
        exit 0
    fi
}

# Enhanced logger
log() {
    local level="$1"
    shift
    local msg="$*"
    local timestamp=$(date '+%H:%M:%S')

    case "$level" in
        INFO)
            echo -e "${DIM}[$timestamp]${NC} ${GREEN}●${NC} $msg"
            ;;
        WARN)
            echo -e "${DIM}[$timestamp]${NC} ${YELLOW}⚠${NC} $msg"
            ;;
        ERROR)
            echo -e "${DIM}[$timestamp]${NC} ${RED}✗${NC} $msg"
            ;;
        SUCCESS)
            echo -e "${DIM}[$timestamp]${NC} ${GREEN}✓${NC} $msg"
            ;;
    esac
}

# Create Mother prompt from template
create_mother_prompt() {
    local user_request="$1"
    USER_REQUEST="$user_request" envsubst < "$TEMPLATES_DIR/mother-prompt.txt"
}

# Create agent prompt from template
create_agent_prompt() {
    local name="$1"
    local window="$2"
    local role="$3"
    local depends="$4"
    local notifies="$5"

    AGENT_NAME="$name" \
    AGENT_WINDOW="$window" \
    AGENT_ROLE="$role" \
    DEPENDS_ON="$depends" \
    NOTIFIES="$notifies" \
    envsubst < "$TEMPLATES_DIR/agent-prompt.txt"
}

# Wait for specification with beautiful progress
wait_for_specification() {
    local target="${SESSION_NAME}:0.0"
    local spec_file="$PROJECT_DIR/.orchestrator/agent_spec.txt"
    local timeout=300  # Increased to 5 minutes
    local elapsed=0
    local wait_time=2

    section_header "WAITING FOR MOTHER'S ANALYSIS"

    echo -e "${WHITE}Mother is analyzing your project and designing the agent architecture...${NC}"
    echo

    local phases=("Analyzing requirements" "Decomposing work units" "Designing agent architecture" "Mapping dependencies")
    local phase_idx=0

    while [ $elapsed -lt $timeout ]; do
        # Capture pane content
        tmux capture-pane -t "$target" -p -S -3000 > "$spec_file" 2>/dev/null || true

        # Check for completion markers
        # Must have <<<DONE>>> AFTER "Begin your analysis" to avoid matching the example
        if grep -q "Begin your analysis and design now" "$spec_file"; then
            # Now look for <<<DONE>>> that comes AFTER the analysis prompt
            local after_prompt=$(sed -n '/Begin your analysis and design now/,$p' "$spec_file")

            # Look for <<<DONE>>> or variations (including <<>> which Claude sometimes outputs)
            if echo "$after_prompt" | grep -qE "(<<<DONE>>>|<<DONE>>|<DONE>|DONE>>>|<<>>)" && \
               echo "$after_prompt" | grep -q "AGENT_SPEC_JSON_START" && \
               echo "$after_prompt" | grep -q "AGENT_SPEC_JSON_END"; then
                # Extra validation: make sure we have actual agent data, not the example
                local has_example=$(echo "$after_prompt" | grep -c "... more agents ..." || true)
                local json_count=$(echo "$after_prompt" | grep -c "AGENT_SPEC_JSON_START" || true)

                # Look for real agent data indicators
                local has_window=$(echo "$after_prompt" | grep -c '"window":[[:space:]]*[0-9]' || true)
                local has_name=$(echo "$after_prompt" | grep -c '"name":[[:space:]]*"[^"]*"' || true)

                # If we have multiple JSON blocks or no example template text, and have real data
                if ([ "$has_example" -eq 0 ] || [ "$json_count" -gt 1 ]) && \
                   [ "$has_window" -gt 0 ] && [ "$has_name" -gt 0 ]; then
                    echo
                    log SUCCESS "${BOLD}Specification received!${NC}"
                    return 0
                fi
            fi
        fi

        # Show rotating phase
        local current_phase="${phases[$phase_idx]}"
        printf "\r  ${CYAN}◆${NC} %-40s ${DIM}[%3ds]${NC}" "$current_phase" "$elapsed"

        # Advance phase every 10 seconds
        if [ $((elapsed % 10)) -eq 0 ] && [ $elapsed -gt 0 ]; then
            phase_idx=$(( (phase_idx + 1) % ${#phases[@]} ))
        fi

        sleep $wait_time
        elapsed=$((elapsed + wait_time))
    done

    echo
    log ERROR "Timeout waiting for specification"
    return 1
}

# Parse JSON specification
parse_json_spec() {
    local spec_file="$1"

    section_header "PARSING AGENT SPECIFICATION"

    log INFO "Extracting JSON from Mother's output..."

    # Check if spec file exists and has content
    if [ ! -f "$spec_file" ] || [ ! -s "$spec_file" ]; then
        log ERROR "Specification file not found or empty"
        return 1
    fi

    # Extract JSON block between markers (take the LAST occurrence, not the first)
    # This avoids capturing the example JSON from the prompt
    # Use tail/sed instead of tac (which isn't on macOS by default)
    local json_block=$(sed -n '/AGENT_SPEC_JSON_START/,/AGENT_SPEC_JSON_END/p' "$spec_file" | \
                      tail -r | \
                      sed -n '/AGENT_SPEC_JSON_END/,/AGENT_SPEC_JSON_START/p' | \
                      tail -r | \
                      grep -v "AGENT_SPEC_JSON" | \
                      sed 's/^[[:space:]]*//' | \
                      grep -v '^```' | \
                      grep -v '^>' | \
                      grep -v '^⏺' | \
                      sed 's/{{/{/g; s/}}/}/g' | \
                      grep -v '\.\.\.' | \
                      tr -d '\r')

    # Debug: Save extracted JSON to file
    echo "$json_block" > "$PROJECT_DIR/.orchestrator/extracted_json.txt"

    if [ -z "$json_block" ]; then
        log ERROR "No JSON block found in specification"
        log INFO "Check $PROJECT_DIR/.orchestrator/agent_spec.txt for raw output"
        return 1
    fi

    # Try to parse with jq
    local agents_json
    if ! agents_json=$(echo "$json_block" | jq -r '.agents' 2>/dev/null); then
        log ERROR "JSON parsing failed - invalid JSON syntax"
        log INFO "Raw JSON saved to: $PROJECT_DIR/.orchestrator/extracted_json.txt"
        return 1
    fi

    if [ -z "$agents_json" ] || [ "$agents_json" = "null" ]; then
        log ERROR "No agents array found in JSON specification"
        log INFO "Raw JSON saved to: $PROJECT_DIR/.orchestrator/extracted_json.txt"
        return 1
    fi

    # Parse each agent
    local count=$(echo "$agents_json" | jq 'length' 2>/dev/null)

    if [ -z "$count" ] || [ "$count" -eq 0 ]; then
        log ERROR "Agents array is empty"
        return 1
    fi

    log SUCCESS "Found ${BOLD}$count agents${NC}"
    echo

    for ((i=0; i<count; i++)); do
        local agent=$(echo "$agents_json" | jq ".[$i]")
        local window=$(echo "$agent" | jq -r '.window')
        local name=$(echo "$agent" | jq -r '.name')
        local role=$(echo "$agent" | jq -r '.role')

        AGENT_WINDOWS+=("$window")
        AGENT_NAMES+=("$name")
        AGENT_ROLES+=("$role")

        echo -e "  ${CYAN}◆${NC} ${BOLD}$name${NC} ${DIM}(window $window)${NC}"
        echo -e "    ${DIM}$role${NC}"
    done

    echo
    return 0
}

# Create agent windows with beautiful progress
create_agent_windows() {
    section_header "SPAWNING AGENTS"

    local total=${#AGENT_NAMES[@]}

    for ((i=0; i<total; i++)); do
        local window="${AGENT_WINDOWS[$i]}"
        local name="${AGENT_NAMES[$i]}"
        local role="${AGENT_ROLES[$i]}"

        progress_bar $((i + 1)) $total
        echo
        log INFO "Spawning ${BOLD}$name${NC} in window $window..."

        # Create window
        tmux new-window -t "${SESSION_NAME}:${window}" -n "$name" -c "$PROJECT_DIR" 2>/dev/null || true

        # Start Claude (always default model)
        tmux send-keys -t "${SESSION_NAME}:${window}.0" "claude --dangerously-skip-permissions" Enter
        sleep 3

        # Accept trust
        tmux send-keys -t "${SESSION_NAME}:${window}.0" "1" Enter
        sleep 1

        # Send agent prompt
        local prompt=$(create_agent_prompt "$name" "$window" "$role" "none" "none")
        printf '%s' "$prompt" | tmux load-buffer -
        tmux paste-buffer -t "${SESSION_NAME}:${window}.0"
        sleep 0.3
        tmux send-keys -t "${SESSION_NAME}:${window}.0" Enter

        show_success "Agent ${BOLD}$name${NC} is ready"
    done

    echo
    log SUCCESS "${BOLD}All $total agents spawned!${NC}"
}

# Send coordination prompt
send_coordination_prompt() {
    section_header "ACTIVATING COORDINATION MODE"

    local target="${SESSION_NAME}:0.0"

    log INFO "Building agent roster..."

    # Build agents info
    local agents_info=""
    for ((i=0; i<${#AGENT_NAMES[@]}; i++)); do
        agents_info+="  Window ${AGENT_WINDOWS[$i]}: ${AGENT_NAMES[$i]}\n"
        agents_info+="    Role: ${AGENT_ROLES[$i]}\n\n"
    done

    # Load and substitute template
    AGENTS_INFO="$agents_info" \
    PROJECT_DIR="$PROJECT_DIR" \
    envsubst < "$TEMPLATES_DIR/coordination-prompt.txt" > /tmp/coord_prompt.txt

    log INFO "Sending coordination protocol to Mother..."

    # Send to Mother
    tmux send-keys -t "$target" C-u
    sleep 0.5

    cat /tmp/coord_prompt.txt | tmux load-buffer -
    tmux paste-buffer -t "$target"
    sleep 0.5
    tmux send-keys -t "$target" Enter

    rm -f /tmp/coord_prompt.txt

    log SUCCESS "Mother is now in ${BOLD}COORDINATION MODE${NC}"
}

# Final launch sequence
launch_sequence() {
    section_header "LAUNCH SEQUENCE"

    echo -e "${WHITE}${BOLD}System Status:${NC}"
    echo -e "  ${GREEN}✓${NC} Project:    $PROJECT_DIR"
    echo -e "  ${GREEN}✓${NC} Session:    $SESSION_NAME"
    echo -e "  ${GREEN}✓${NC} Mother:     Window 0 (Coordinating)"
    echo -e "  ${GREEN}✓${NC} Agents:     ${#AGENT_NAMES[@]} agents spawned"
    echo -e "  ${GREEN}✓${NC} Mode:       Full orchestration active"
    echo

    echo -e "${CYAN}${BOLD}Navigation:${NC}"
    echo -e "  ${DIM}◆${NC} Ctrl+b 0-9  ${DIM}→${NC} Jump to window"
    echo -e "  ${DIM}◆${NC} Ctrl+b n    ${DIM}→${NC} Next window"
    echo -e "  ${DIM}◆${NC} Ctrl+b d    ${DIM}→${NC} Detach (keeps running)"
    echo

    for i in 3 2 1; do
        echo -ne "\r${GREEN}${BOLD}Attaching to session in ${i}...${NC}"
        sleep 1
    done
    echo
    echo
}

# Main orchestration flow
main() {
    # Parse args first
    while [[ $# -gt 0 ]]; do
        case $1 in
            -f|--file)
                [ ! -f "$2" ] && { log ERROR "File not found: $2"; exit 1; }
                PROJECT_PROMPT=$(cat "$2")
                shift 2
                ;;
            -p|--prompt)
                PROJECT_PROMPT="$2"
                shift 2
                ;;
            -q|--quick)
                QUICK_MODE=true
                shift
                ;;
            --session-name)
                SESSION_NAME="$2"
                shift 2
                ;;
            -v|--version)
                echo "TACO v$VERSION (Bash Edition)"
                exit 0
                ;;
            -h|--help)
                cat <<EOF
Usage: $0 [OPTIONS]

Options:
    -f, --file FILE         Load project from file
    -p, --prompt TEXT       Project description (skip all prompts)
    -q, --quick             Quick mode (just description, auto-detect rest)
    --session-name NAME     Custom tmux session name [default: taco]
    -v, --version           Show version
    -h, --help              Show this help

Examples:
    $0                      # Interactive with questionnaire
    $0 -q                   # Quick mode (just description)
    $0 -p "Build a chat app" # Skip all prompts
    $0 -f project.txt       # Load from file

EOF
                exit 0
                ;;
            *)
                log ERROR "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    # Show beautiful logo
    show_taco_logo

    # Check dependencies
    check_dependencies

    # Get project description
    if [ -z "$PROJECT_PROMPT" ]; then
        if [ "$QUICK_MODE" = true ]; then
            get_quick_description
        else
            run_questionnaire
        fi
        show_configuration
    fi

    [ -z "$PROJECT_PROMPT" ] && { log ERROR "No project description"; exit 1; }

    # Setup
    section_header "INITIALIZING TACO"

    log INFO "Setting up project workspace..."

    # Create or use directory based on user choice
    if [ "$USE_NEW_DIR" = true ]; then
        if [ -z "$PROJECT_NAME" ]; then
            PROJECT_NAME="taco-project-$(date +%Y%m%d-%H%M%S)"
        fi
        PROJECT_DIR="$(pwd)/$PROJECT_NAME"
        mkdir -p "$PROJECT_DIR"
        show_success "Created directory: ${BOLD}$PROJECT_DIR${NC}"
    else
        PROJECT_DIR="$(pwd)"
        show_success "Using current directory: ${BOLD}$PROJECT_DIR${NC}"
    fi

    mkdir -p "$PROJECT_DIR/.orchestrator"

    log INFO "Creating tmux session..."
    tmux has-session -t "$SESSION_NAME" 2>/dev/null && tmux kill-session -t "$SESSION_NAME"
    tmux new-session -d -s "$SESSION_NAME" -n "mother" -c "$PROJECT_DIR"
    show_success "Session: ${BOLD}$SESSION_NAME${NC}"

    # Start Mother
    section_header "LAUNCHING MOTHER AGENT"

    log INFO "Starting Claude in Mother window..."
    local target="${SESSION_NAME}:0.0"

    # Always use default model (no flag = sonnet)
    tmux send-keys -t "$target" "claude --dangerously-skip-permissions" Enter
    sleep 5

    log INFO "Accepting security prompt..."
    tmux send-keys -t "$target" "1" Enter
    sleep 2

    log INFO "Transmitting project requirements..."
    local mother_prompt=$(create_mother_prompt "$PROJECT_PROMPT")
    printf '%s' "$mother_prompt" | tmux load-buffer -
    tmux paste-buffer -t "$target"
    sleep 0.5
    tmux send-keys -t "$target" Enter

    show_success "Mother agent is ${BOLD}ANALYZING${NC}"

    # Wait for spec
    wait_for_specification || exit 1

    # Parse spec
    parse_json_spec "$PROJECT_DIR/.orchestrator/agent_spec.txt" || exit 1

    # Create agents
    sleep 2
    create_agent_windows

    # Send coordination
    sleep 5
    send_coordination_prompt

    # Launch!
    sleep 2
    launch_sequence

    tmux attach -t "${SESSION_NAME}:0"
}

main "$@"
